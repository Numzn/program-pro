# Database Migration Guide

This guide explains how to use Alembic migrations to keep your database schema in sync with your SQLAlchemy models as you add new features.

## Overview

We use **Alembic** for database migrations. Migrations are version-controlled files that:
- Track schema changes over time
- Apply changes safely without losing data
- Enable rollback if needed
- Run automatically on server startup

## Current Migration Status

- **Initial Schema**: `001_initial_schema.py` - Creates all base tables
- **Add Address Column**: `002_add_churches_address.py` - Adds missing address column

## How It Works

1. **On Server Startup**: Migrations run automatically via `run_migrations()` in `main.py`
2. **Migration Files**: Stored in `server/alembic/versions/`
3. **Automatic Detection**: Alembic compares current database state with models

## Adding New Features (Creating Migrations)

When you modify your models (add columns, tables, etc.):

### Step 1: Update Your Models

Edit `server/app/models/database.py` to add your changes:

```python
class Church(Base):
    # ... existing columns ...
    phone_number = Column(String(50))  # New column example
```

### Step 2: Generate Migration

On your local machine or in a Python environment with Alembic:

```bash
cd server
alembic revision --autogenerate -m "Add phone_number to churches"
```

This creates a new file in `server/alembic/versions/` like:
- `003_add_phone_number.py`

### Step 3: Review Migration File

**Always review the generated migration!** Check `server/alembic/versions/003_add_phone_number.py`:

```python
def upgrade() -> None:
    op.add_column('churches', sa.Column('phone_number', sa.String(length=50), nullable=True))

def downgrade() -> None:
    op.drop_column('churches', 'phone_number')
```

Make sure:
- ✅ The changes look correct
- ✅ No unintended deletions
- ✅ Data types match your models
- ✅ Foreign keys are handled properly

### Step 4: Test Migration Locally

Test the migration on a development database:

```bash
# Apply migration
alembic upgrade head

# Verify changes
# (check your database schema)

# Rollback if needed
alembic downgrade -1
```

### Step 5: Commit and Deploy

1. Commit the migration file to git:
   ```bash
   git add server/alembic/versions/003_add_phone_number.py
   git commit -m "Add phone_number column to churches table"
   git push
   ```

2. Deploy to Render
3. Migrations will run automatically on server startup

## Manual Migration Commands

If you need to run migrations manually:

### Check Current Revision
```bash
cd server
alembic current
```

### Apply All Pending Migrations
```bash
cd server
alembic upgrade head
```

### Apply Specific Migration
```bash
cd server
alembic upgrade <revision_id>
```

### Rollback One Migration
```bash
cd server
alembic downgrade -1
```

### Rollback to Specific Revision
```bash
cd server
alembic downgrade <revision_id>
```

## Migration Safety

### Production Safety

- Migrations run automatically on startup
- Errors are logged but don't crash the server
- Consider backing up database before major migrations

### Best Practices

1. **Test First**: Always test migrations on development database
2. **Review Generated Code**: Check autogenerated migrations carefully
3. **Backup Data**: For major changes, backup your production database
4. **Small Steps**: Break large schema changes into smaller migrations
5. **Documentation**: Add comments to migration files explaining why

## Common Migration Patterns

### Adding a Column

```python
def upgrade() -> None:
    op.add_column('table_name', sa.Column('new_column', sa.String(255), nullable=True))

def downgrade() -> None:
    op.drop_column('table_name', 'new_column')
```

### Adding a Table

```python
def upgrade() -> None:
    op.create_table(
        'new_table',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('name', sa.String(255), nullable=False),
        sa.PrimaryKeyConstraint('id')
    )

def downgrade() -> None:
    op.drop_table('new_table')
```

### Adding Foreign Key

```python
def upgrade() -> None:
    op.add_column('table_name', sa.Column('foreign_id', sa.Integer(), nullable=True))
    op.create_foreign_key('fk_name', 'table_name', 'other_table', ['foreign_id'], ['id'])

def downgrade() -> None:
    op.drop_constraint('fk_name', 'table_name', type_='foreignkey')
    op.drop_column('table_name', 'foreign_id')
```

## Troubleshooting

### Migration Fails on Startup

1. Check Render logs for error messages
2. Verify DATABASE_URL is correct
3. Ensure Alembic can access the database
4. Fallback: `create_tables()` will run if migrations fail

### Schema Out of Sync

If your database schema doesn't match models:

1. Generate a new migration: `alembic revision --autogenerate -m "Sync schema"`
2. Review the generated changes
3. Apply the migration

### Need to Reset Database

**⚠️ WARNING: This deletes all data!**

```bash
# Drop all tables
alembic downgrade base

# Recreate from scratch
alembic upgrade head
```

## File Structure

```
server/
├── alembic.ini              # Alembic configuration
├── alembic/
│   ├── env.py               # Alembic environment setup
│   ├── script.py.mako       # Migration template
│   └── versions/            # Migration files
│       ├── 001_initial_schema.py
│       ├── 002_add_churches_address.py
│       └── ...                # Future migrations
└── app/
    └── database/
        └── migrations.py    # Migration runner functions
```

## Questions?

If you encounter issues:
1. Check Alembic documentation: https://alembic.sqlalchemy.org/
2. Review migration files in `server/alembic/versions/`
3. Check server logs for migration errors
4. Verify database connection and permissions

